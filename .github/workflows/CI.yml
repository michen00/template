name: CI

on:
  pull_request:
    branches:
      - main
    paths:
      - ".codespellrc"
      - ".coveragerc"
      - ".editorconfig"
      - ".pylintrc"
      - ".python-version"
      - "**/*.lock"
      - "**/*.md"
      - "**/*.py"
      - "**/*.sh"
      - "**/*.toml"
      - "**/*.yaml"
      - "**/*.yml"
      - "src/**"
      - "tests/**"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash -el {0}

env:
  CACHE_NUMBER: 0

jobs:
  run-ci:
    name: Run CI
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Secret scanning
        uses: trufflesecurity/trufflehog@v3.91.2
        with:
          extra_args: --results=verified,unknown
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: |
            .github/workflows/.cache-buster
            .github/workflows/CI.yml
            noxfile.py
            pyproject.toml
            uv.lock
      - name: Prepare cache keys
        id: prepare-cache-keys
        env:
          HASH_UV: ${{ hashFiles('uv.lock') }}
          HASH_PYPROJECT: ${{ hashFiles('pyproject.toml') }}
          HASH_PRECOMMIT: ${{ hashFiles('.pre-commit-config.yaml') }}
          HASH_NOXFILE: ${{ hashFiles('noxfile.py') }}
        run: |-
          STAMP="$(date +'%Y%m%d')-${CACHE_NUMBER}"
          py="${HASH_PYPROJECT}-${STAMP}"
          uv="${HASH_UV}-${py}"
          {
            echo "py=${py}"
            echo "uv=${uv}"
            echo "pc=${HASH_PRECOMMIT}-${STAMP}"
            echo "nox=${HASH_NOXFILE}-${uv}"
          } >> "$GITHUB_OUTPUT"
      - name: Cache .venv directory
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ runner.os }}-venv-${{ steps.prepare-cache-keys.outputs.uv }}
      - name: Cache pre-commit hooks
        id: cache-pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: ${{ runner.os }}-precommit-${{ steps.prepare-cache-keys.outputs.pc }}
      - name: Cache nox environments
        uses: actions/cache@v4
        with:
          path: .nox
          key: ${{ runner.os }}-nox-${{ steps.prepare-cache-keys.outputs.nox }}
      - name: Install dependencies
        run: uv sync --no-editable --no-install-project
      - name: Run pytest
        run: |-
          uv sync --only-group test
          uv run nox -s test
      - name: Lint code
        run: |-
          uv sync --only-dev
          bash .github/scripts/ci-ruff-args.sh
          uv run nox -s precommit
